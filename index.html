<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emotion Waveform</title>
<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    margin: 0;
    background: #ffffff;
  }

  .canvas-wrap {
    display:flex;
    justify-content:center;
    align-items:center;
    padding:40px 20px 20px 20px;
  }

  canvas {
    width: 100%;
    max-width: 1200px;
  }

  .ui {
    padding: 20px;
    border-top: 1px solid #eee;
  }

  textarea {
    width: 100%;
    height: 160px;
    padding: 10px;
    font-size: 14px;
  }

  button {
    margin-top: 10px;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div class="canvas-wrap">
  <canvas id="c" width="1600" height="700"></canvas>
</div>

<div class="ui">
  <textarea id="input">I love this app but it crashes now. Never again, I'm done.</textarea>
  <br/>
  <button onclick="generate()">Generate</button>
  <button onclick="downloadPNG()">Download PNG</button>
</div>

<script>
const COLORS = {
  basic_pos:"#00FF90",
  strong_pos:"#DFFF29",
  attach_pos:"#FF6134",
  extreme_pos:"#F7399D",
  mild_neg:"#00FFFF",
  strong_neg:"#006AA0",
  extreme_neg:"#020605"
};

const KW = {
  attach_pos:new Set(["love","favorite","obsessed"]),
  strong_pos:new Set(["great","amazing","fantastic"]),
  basic_pos:new Set(["good","nice","helpful"]),
  mild_neg:new Set(["slow","buggy","annoying","crash","crashes"]),
  strong_neg:new Set(["bad","terrible","broken"]),
  extreme_neg:new Set(["worst","scam","delete","done","never","again"])
};

const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");

let seed=1234;
function rand(){
  seed=(seed*1664525+1013904223)%4294967296;
  return seed/4294967296;
}

function pickCategory(tokens){
  let best="basic_pos",score=0;
  for(const t of tokens){
    const w=t.toLowerCase();
    for(const k in KW){
      if(KW[k].has(w)){
        score++;
        best=k;
      }
    }
  }
  return best;
}

function intensity(tokens){
  return Math.min(10,tokens.length/2);
}

function generate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const text=document.getElementById("input").value;
  const sentences=text.split(/[.!?]/).map(s=>s.trim()).filter(Boolean);

  const marginX=100;
  const usableW=canvas.width-marginX*2;
  const lineHeight=200;
  let y=canvas.height/2 - (sentences.length-1)*lineHeight/2;

  for(const sentence of sentences){
    const tokens=sentence.split(/\s+/);
    const cat=pickCategory(tokens);
    const color=COLORS[cat];
    const ampMax=20 + intensity(tokens)*4;

    drawWave(sentence,y,usableW,marginX,color,ampMax);
    y+=lineHeight;
  }
}

function drawWave(sentence,yCenter,width,xStart,color,ampMax){
  const tokens=sentence.split(/\s+/);
  const total=tokens.length;

  let x=xStart;

  ctx.save();
  ctx.fillStyle=color;
  ctx.globalAlpha=0.8;

  const resolution=500;
  const step=width/resolution;

  let mode=1;

  ctx.beginPath();

  for(let i=0;i<=resolution;i++){
    const t=i/resolution;
    const currentIndex=Math.floor(t*total);
    const word=tokens[currentIndex]||"";

    if(word.toLowerCase()==="but") mode=2;
    if(word.toLowerCase()==="now") mode=3;
    if(word.toLowerCase()==="done"||word.toLowerCase()==="delete") mode=4;

    let amp=0;

    if(mode===1){
      amp=ampMax*(0.5+0.5*Math.sin(t*Math.PI))* (0.5+rand());
    }
    if(mode===2){
      amp=ampMax*(rand()*1.2);
    }
    if(mode===3){
      amp=ampMax*(0.6+0.4*Math.sin(40*t));
    }
    if(mode===4){
      amp=ampMax*2*Math.exp(-8*(t));
    }

    const xPos=xStart+i*step;
    const yPos=yCenter-amp;

    if(i===0) ctx.moveTo(xPos,yPos);
    else ctx.lineTo(xPos,yPos);
  }

  for(let i=resolution;i>=0;i--){
    const t=i/resolution;
    const currentIndex=Math.floor(t*total);
    const word=tokens[currentIndex]||"";

    let amp=0;

    if(mode===1){
      amp=ampMax*(0.5+0.5*Math.sin(t*Math.PI))* (0.5+rand());
    }
    if(mode===2){
      amp=ampMax*(rand()*1.2);
    }
    if(mode===3){
      amp=ampMax*(0.6+0.4*Math.sin(40*t));
    }
    if(mode===4){
      amp=ampMax*2*Math.exp(-8*(t));
    }

    const xPos=xStart+i*step;
    const yPos=yCenter+amp;
    ctx.lineTo(xPos,yPos);
  }

  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

function downloadPNG(){
  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/png");
  a.download="emotion-wave.png";
  a.click();
}

generate();
</script>
</body>
</html>
